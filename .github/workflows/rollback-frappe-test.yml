name: Rollback Frappe Deployment (Test - invoice)

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: "Rollback target"
        required: true
        type: choice
        options:
          - "Previous commit"
          - "Specific commit"
          - "Last successful deployment"
      commit_sha:
        description: 'Specific commit SHA (only if "Specific commit" selected)'
        required: false
        type: string
      skip_build:
        description: "Skip build step (faster but risky)"
        required: false
        type: boolean
        default: false
      reason:
        description: "Rollback reason (required)"
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: test
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for rollback

      - name: Validate inputs
        run: |
          echo "üîç Validating rollback inputs..."
          echo "Target: ${{ github.event.inputs.rollback_target }}"
          echo "Commit SHA: ${{ github.event.inputs.commit_sha }}"
          echo "Skip build: ${{ github.event.inputs.skip_build }}"
          echo "Reason: ${{ github.event.inputs.reason }}"

          if [ "${{ github.event.inputs.rollback_target }}" == "Specific commit" ] && [ -z "${{ github.event.inputs.commit_sha }}" ]; then
            echo "‚ùå ERROR: Commit SHA required when rolling back to specific commit"
            exit 1
          fi

      - name: Notify rollback started
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"warning\",
                \"title\": \"‚è™ Frappe Test Rollback Started (invoice)\",
                \"fields\": [
                  {\"title\": \"Environment\", \"value\": \"üß™ Test\", \"short\": true},
                  {\"title\": \"Target\", \"value\": \"${{ github.event.inputs.rollback_target }}\", \"short\": true},
                  {\"title\": \"Reason\", \"value\": \"${{ github.event.inputs.reason }}\", \"short\": false},
                  {\"title\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ],
                \"ts\": $(date +%s)
              }]
            }"

      - name: Perform rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CULLINAR_ERP_TEST_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.CULLINAR_ERP_TEST_EC2_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            #!/bin/bash
            set -e
            set -o pipefail

            # Redirect output
            exec > >(tee -a /home/ubuntu/rollback-test.log)
            exec 2>&1

            echo "==========================================="
            echo "‚è™ Starting Frappe Test Rollback"
            echo "==========================================="
            echo "üß™ Environment: Test"
            echo "üìÖ Date: $(date)"
            echo "üéØ Target: ${{ github.event.inputs.rollback_target }}"
            echo "üìù Reason: ${{ github.event.inputs.reason }}"
            echo "üë§ User: ${{ github.actor }}"
            echo ""

            # Lock
            LOCK_FILE="/tmp/frappe_rollback_test.lock"
            exec 9>"$LOCK_FILE"

            if ! flock -n 9; then
              echo "‚ùå Another rollback/deployment is running"
              exit 1
            fi

            echo "‚úÖ Lock acquired"

            cleanup() {
              flock -u 9 2>/dev/null || true
              exit $?
            }

            trap cleanup EXIT INT TERM

            # Backup before rollback
            echo ""
            echo "üíæ Creating Pre-Rollback Backup"
            echo "-----------------------------------"

            BENCH_DIR="/home/ubuntu/frappe-bench-test"
            APP_DIR="$BENCH_DIR/apps/invoice"
            BACKUP_DIR="/home/ubuntu/backups/frappe-test"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            mkdir -p "$BACKUP_DIR"

            cd "$APP_DIR"

            # Save current state
            CURRENT_COMMIT=$(git rev-parse HEAD)
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

            echo "üìå Current commit: $CURRENT_COMMIT"
            echo "üåø Current branch: $CURRENT_BRANCH"

            # Create state file
            cat > "$BACKUP_DIR/state_before_rollback_$TIMESTAMP.txt" << EOF
            Environment: Test
            Rollback Date: $(date)
            Current Commit: $CURRENT_COMMIT
            Current Branch: $CURRENT_BRANCH
            Rollback Target: ${{ github.event.inputs.rollback_target }}
            Target Commit: ${{ github.event.inputs.commit_sha }}
            Reason: ${{ github.event.inputs.reason }}
            Triggered By: ${{ github.actor }}
            EOF

            echo "‚úÖ State saved: $BACKUP_DIR/state_before_rollback_$TIMESTAMP.txt"

            # Database backup
            echo ""
            echo "üóÑÔ∏è  Creating Database Backup"
            echo "-----------------------------------"

            cd "$BENCH_DIR"

            if bench --site all backup --with-files 2>&1; then
              echo "‚úÖ Database backup completed"

              LATEST_BACKUP=$(find sites/*/private/backups -name "*.sql.gz" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")
              if [ -n "$LATEST_BACKUP" ]; then
                cp "$LATEST_BACKUP" "$BACKUP_DIR/db_backup_$TIMESTAMP.sql.gz"
                echo "üì¶ Backup copied to: $BACKUP_DIR/db_backup_$TIMESTAMP.sql.gz"
              fi
            else
              echo "‚ö†Ô∏è  Database backup failed, but continuing..."
            fi

            # Determine target commit
            echo ""
            echo "üéØ Determining Target Commit"
            echo "-----------------------------------"

            cd "$APP_DIR"

            case "${{ github.event.inputs.rollback_target }}" in
              "Previous commit")
                TARGET_COMMIT=$(git rev-parse HEAD~1)
                echo "üìç Rolling back to previous commit: $TARGET_COMMIT"
                ;;

              "Specific commit")
                if [ -z "${{ github.event.inputs.commit_sha }}" ]; then
                  echo "‚ùå No commit SHA provided"
                  exit 1
                fi

                if ! git cat-file -e "${{ github.event.inputs.commit_sha }}^{commit}" 2>/dev/null; then
                  echo "‚ùå Invalid commit SHA: ${{ github.event.inputs.commit_sha }}"
                  exit 1
                fi

                TARGET_COMMIT="${{ github.event.inputs.commit_sha }}"
                echo "üìç Rolling back to specified commit: $TARGET_COMMIT"
                ;;

              "Last successful deployment")
                LAST_SUCCESS=$(git tag -l "deploy-test-success-*" | sort -r | head -1)

                if [ -n "$LAST_SUCCESS" ]; then
                  TARGET_COMMIT=$(git rev-list -n 1 "$LAST_SUCCESS")
                  echo "üìç Rolling back to last successful: $TARGET_COMMIT ($LAST_SUCCESS)"
                else
                  echo "‚ö†Ô∏è  No successful deployment tag found, using previous commit"
                  TARGET_COMMIT=$(git rev-parse HEAD~1)
                fi
                ;;

              *)
                echo "‚ùå Unknown rollback target: ${{ github.event.inputs.rollback_target }}"
                exit 1
                ;;
            esac

            echo "‚úÖ Target commit: $TARGET_COMMIT"
            echo ""
            echo "üìù Target commit details:"
            git log -1 --pretty=format:"Author: %an <%ae>%nDate: %ad%nMessage: %s%n" "$TARGET_COMMIT"

            # Confirmation
            echo ""
            echo "‚ö†Ô∏è  ROLLBACK CONFIRMATION"
            echo "-----------------------------------"
            echo "FROM: $CURRENT_COMMIT"
            echo "TO:   $TARGET_COMMIT"
            echo ""

            COMMITS_TO_ROLLBACK=$(git rev-list --count "$TARGET_COMMIT..$CURRENT_COMMIT")
            echo "üìä Rolling back $COMMITS_TO_ROLLBACK commit(s)"

            # Stop services
            echo ""
            echo "üõë Stopping Frappe Services"
            echo "-----------------------------------"

            cd "$BENCH_DIR"

            sudo supervisorctl stop frappe-bench-test-web:* 2>&1 || true
            sudo supervisorctl stop frappe-bench-test-workers:* 2>&1 || true

            sleep 3
            echo "‚úÖ Services stopped"

            # Git rollback
            echo ""
            echo "üîÑ Performing Git Rollback"
            echo "-----------------------------------"

            cd "$APP_DIR"

            # Stash uncommitted changes
            if ! git diff-index --quiet HEAD --; then
              echo "üíæ Stashing uncommitted changes..."
              git stash save "pre-rollback-stash-$TIMESTAMP"
            fi

            # Checkout target
            echo "üîÄ Checking out commit: $TARGET_COMMIT"
            if ! git checkout "$TARGET_COMMIT" 2>&1; then
              echo "‚ùå Failed to checkout target commit"
              exit 1
            fi

            echo "‚úÖ Git rollback completed"
            echo "Current HEAD:"
            git log -1 --oneline

            # Build
            cd "$BENCH_DIR"

            if [ "${{ github.event.inputs.skip_build }}" == "true" ]; then
              echo ""
              echo "‚è≠Ô∏è  Skipping build (as requested)"
            else
              echo ""
              echo "üèóÔ∏è  Building Assets"
              echo "-----------------------------------"

              if timeout 10m bench build --app invoice 2>&1; then
                echo "‚úÖ Build completed"
              else
                echo "‚ùå Build failed"
                echo "‚ö†Ô∏è  Attempting to restore previous state..."

                cd "$APP_DIR"
                git checkout "$CURRENT_COMMIT"

                echo "‚ùå Rollback aborted - restored to previous state"
                exit 1
              fi
            fi

            # Clear cache
            echo ""
            echo "üßπ Clearing Cache"
            echo "-----------------------------------"

            bench --site all clear-cache 2>&1 || echo "‚ö†Ô∏è  Cache clear warning"

            # Restart services
            echo ""
            echo "üîÅ Restarting Services"
            echo "-----------------------------------"

            sudo supervisorctl start frappe-bench-test-web:* 2>&1
            sudo supervisorctl start frappe-bench-test-workers:* 2>&1

            sleep 5

            echo ""
            echo "üìä Supervisor Status:"
            sudo supervisorctl status

            # Health check
            echo ""
            echo "üè• Health Check"
            echo "-----------------------------------"

            sleep 5

            if sudo supervisorctl status | grep -qE "BACKOFF|FATAL|EXITED"; then
              echo "‚ùå Some services failed to start:"
              sudo supervisorctl status | grep -E "BACKOFF|FATAL|EXITED" || true

              echo ""
              echo "‚ö†Ô∏è  ROLLBACK PARTIALLY FAILED"
              echo "Manual intervention required"

              exit 1
            fi

            RUNNING_COUNT=$(sudo supervisorctl status | grep -c "RUNNING" || echo "0")
            echo "‚úÖ Services running: $RUNNING_COUNT"

            # Create rollback marker
            echo ""
            echo "üè∑Ô∏è  Creating Rollback Marker"
            echo "-----------------------------------"

            cd "$APP_DIR"

            git tag -a "rollback-test-$TIMESTAMP" -m "Test rollback to $TARGET_COMMIT - Reason: ${{ github.event.inputs.reason }}"

            echo "‚úÖ Tag created: rollback-test-$TIMESTAMP"

            # Summary
            echo ""
            echo "==========================================="
            echo "‚úÖ Test Rollback Completed Successfully"
            echo "==========================================="
            echo "üß™ Environment: Test"
            echo "üìÖ Completed at: $(date)"
            echo "üîô Rolled back from: $CURRENT_COMMIT"
            echo "üìç Rolled back to: $TARGET_COMMIT"
            echo "üíæ Backup location: $BACKUP_DIR"
            echo "üè∑Ô∏è  Rollback tag: rollback-test-$TIMESTAMP"
            echo ""
            echo "‚ö†Ô∏è  IMPORTANT NOTES:"
            echo "1. Database migrations were NOT rolled back"
            echo "2. If issues persist, restore from backup:"
            echo "   bench --site all restore $BACKUP_DIR/db_backup_$TIMESTAMP.sql.gz"
            echo "==========================================="

      - name: Upload rollback logs
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CULLINAR_ERP_TEST_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.CULLINAR_ERP_TEST_EC2_SSH_KEY }}
          script: |
            if [ -f /home/ubuntu/rollback-test.log ]; then
              echo "üìÑ Test Rollback log (last 100 lines):"
              tail -100 /home/ubuntu/rollback-test.log
            fi

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI=":white_check_mark:"
            STATUS_TEXT="SUCCESS"
            COLOR="good"
          else
            STATUS_EMOJI=":x:"
            STATUS_TEXT="FAILED"
            COLOR="danger"
          fi

          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$STATUS_EMOJI Frappe Test Rollback $STATUS_TEXT (invoice)\",
                \"fields\": [
                  {\"title\": \"Environment\", \"value\": \"üß™ Test\", \"short\": true},
                  {\"title\": \"Target\", \"value\": \"${{ github.event.inputs.rollback_target }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.event.inputs.commit_sha }}\", \"short\": true},
                  {\"title\": \"Reason\", \"value\": \"${{ github.event.inputs.reason }}\", \"short\": false},
                  {\"title\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ],
                \"footer\": \"Frappe Rollback System\",
                \"ts\": $(date +%s)
              }]
            }"